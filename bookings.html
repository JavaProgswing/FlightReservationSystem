<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>My Bookings</title>
    <link rel="stylesheet" href="style.css" />

  </head>
  <body>
    <header class="top">
      <button id="themeToggle">üåô</button>
      <h1>My Bookings</h1>
      <div>
        <button id="btnBack">Search Flights</button>
        <button id="btnLogout">Logout</button>
      </div>
    </header>

    <main class="container">
      <section class="card">
        <div id="bookingsList">Loading bookings...</div>
      </section>
    </main>

    <script src="app.js"></script>
    <script>
      ensureAuth();

      document.getElementById("btnBack").addEventListener("click", () => {
        location.href = "flights.html";
      });
      document.getElementById("btnLogout").addEventListener("click", logout);

      function formatDateTime(iso) {
        if (!iso) return "-";
        const date = new Date(iso);
        return date.toLocaleString(undefined, {
          dateStyle: "medium",
          timeStyle: "short",
        });
      }

      async function loadHistory() {
        try {
          const items = await apiGet("/bookings/history");
          const list = document.getElementById("bookingsList");

          if (!items || items.length === 0) {
            list.innerHTML = "<p>No bookings found.</p>";
            return;
          }

          list.innerHTML = items
            .map((b) => {
              const f = b.flight || {};
              const dep = formatDateTime(f.departureTime);
              const arr = formatDateTime(f.arrivalTime);

              return `
                <div class="booking">
                  <h4>${escapeHtml(f.airline || "Unknown Airline")}</h4>
                  <div class="flight-route">
                    ‚úàÔ∏è ${escapeHtml(f.source || "-")} ‚Üí ${escapeHtml(
                f.destination || "-"
              )}
                  </div>
                  <div class="flight-time">
                    Departure: ${dep}<br/>
                    Arrival: ${arr}<br/>
                    Aircraft: ${escapeHtml(f.aircraftType || "-")}
                  </div>
                  <div>üë§ Passenger: ${escapeHtml(
                    b.passengerName || "-"
                  )} &nbsp;|&nbsp; Seat: ${escapeHtml(b.seatNo || "-")}</div>
                  <div>üí∞ Fare: ‚Çπ${f.fare ? f.fare.toFixed(2) : "‚Äî"}</div>
                  <div>
                    üïì Booked on: ${formatDateTime(b.bookingTime)}
                  </div>
                  <div class="status ${b.status}">
                    ${escapeHtml(b.status || "PENDING")}
                  </div>
                  ${
                    b.status === "CONFIRMED"
                      ? `<div style="margin-top:8px;">
                          <button data-id="${b.bookingId}" class="btnCancel" style="background:var(--danger)">
                            Cancel Booking
                          </button>
                        </div>`
                      : ""
                  }
                </div>`;
            })
            .join("");

          document.querySelectorAll(".btnCancel").forEach((b) =>
            b.addEventListener("click", async (e) => {
              const id = e.target.dataset.id;
              if (!confirm("Cancel this booking?")) return;
              try {
                await apiDelete("/bookings/cancel/" + id);
                alert("Booking cancelled successfully!");
                loadHistory();
              } catch (err) {
                console.error(err);
                alert("Cancel failed: " + (err.message || "Unknown error"));
              }
            })
          );
        } catch (err) {
          console.error("Failed to load bookings:", err);
          document.getElementById("bookingsList").innerHTML =
            "<p>Error loading bookings. Please try again later.</p>";
        }
      }

      loadHistory();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script>
      // Theme toggle
      const themeToggle = document.getElementById("themeToggle");
      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark");
        themeToggle.textContent = "‚òÄÔ∏è";
      }
      themeToggle.addEventListener("click", () => {
        document.body.classList.toggle("dark");
        const isDark = document.body.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        themeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
      });

      // Subtle animation
      anime({
        targets: ".card, .top",
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 900,
        delay: anime.stagger(120),
        easing: "easeOutQuint",
      });
    </script>
  </body>
</html>
