<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Flight Booking</title>
    <link rel="stylesheet" href="style.css" />

  </head>
  <body>
    <header class="top">
      <button id="themeToggle" class="theme-btn">üåô</button>
      <h1>‚úàÔ∏è Flight Booking</h1>
      <div>
        <button id="btnProfile">My Bookings</button>
        <button id="btnLogout">Logout</button>
      </div>
    </header>

    <main class="container fadeInUp">
      <section class="card search-filter-panel">
        <form id="searchForm" class="search-form">
          <div class="row">
            <input name="source" placeholder="Source" required />
            <input name="destination" placeholder="Destination" required />
          </div>

          <div class="row">
            <input name="date" type="date" required />
            <button type="submit">Search</button>
            <button id="btnAll" type="button">Show All</button>
          </div>
        </form>

        <div class="filters">
          <div class="filter-item sort">
            <label>Sort By</label>
            <select id="filterSort">
              <option value="">None</option>
              <option value="low">Fare: Low ‚Üí High</option>
              <option value="high">Fare: High ‚Üí Low</option>
            </select>
          </div>

          <div class="row">
            <div class="filter-item">
              <label>Airline</label>
              <select id="filterAirline">
                <option value="">All</option>
                <option>IndiGo</option>
                <option>Air India</option>
                <option>Vistara</option>
                <option>SpiceJet</option>
                <option>Emirates</option>
                <option>Qatar Airways</option>
              </select>
            </div>

            <div class="filter-item">
              <label>Max Fare</label>
              <input
                id="filterFare"
                type="range"
                min="2000"
                max="50000"
                value="30000"
              />
              <span id="showFare">‚Çπ30000</span>
            </div>
          </div>
        </div>
      </section>

      <section class="card results">
        <h2>Results</h2>
        <div id="flightsList" class="flightsList">Loading...</div>
      </section>
    </main>

    <!-- Modal -->
    <div id="modal" class="modal hidden">
      <div class="modal-content fadeInUp">
        <h3>Select Your Seat</h3>
        <div id="seatGrid" class="seat-grid"></div>
        <form id="bookForm">
          <input type="hidden" name="flightId" />
          <input type="hidden" name="seatNo" id="seatNo" />
          <label>
            Name:
            <input
              name="passengerName"
              required
              id="passengerName"
              placeholder="Enter your name"
            />
          </label>

          <div class="modal-actions">
            <button type="submit">Confirm</button>
            <button
              type="button"
              id="btnCancelModal"
              style="background: var(--danger)"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="app.js"></script>
    <script>
      ensureAuth(); // redirect to login if not authenticated
      const flightsList = document.getElementById("flightsList");
      const searchForm = document.getElementById("searchForm");
      const btnAll = document.getElementById("btnAll");
      const modal = document.getElementById("modal");
      const bookForm = document.getElementById("bookForm");

      // Autofill passenger name from localStorage
      const passengerInput = document.getElementById("passengerName");
      const profileName = localStorage.getItem("profileName");
      if (profileName) {
        passengerInput.value = profileName;
        passengerInput.placeholder = profileName;
      }

      document.getElementById("btnLogout").addEventListener("click", () => {
        logout();
      });
      document.getElementById("btnProfile").addEventListener("click", () => {
        location.href = "bookings.html";
      });

      searchForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        await doSearch(data.source, data.destination, data.date || null);
      });

      btnAll.addEventListener("click", loadAll);

      let allFlights = [];
      let filteredFlights = [];

      // Update filters on change
      const filterAirline = document.getElementById("filterAirline");
      const filterFare = document.getElementById("filterFare");
      const filterSort = document.getElementById("filterSort");
      const showFare = document.getElementById("showFare");
      const sourceInput = searchForm.elements["source"];
      const destinationInput = searchForm.elements["destination"];
      const dateInput = searchForm.elements["date"];

      filterAirline.addEventListener("change", applyFilters);
      filterFare.addEventListener("input", () => {
        showFare.textContent = "‚Çπ" + filterFare.value;
        applyFilters();
      });
      filterSort.addEventListener("change", applyFilters);

      async function loadAll() {
        allFlights = await apiGet("/flights");
        filteredFlights = [...allFlights];
        sourceInput.value = "";
        destinationInput.value = "";
        dateInput.value = "";
        applyFilters();
      }

      // Combined filter logic (works after search too)
      function applyFilters() {
        let list = [...filteredFlights];
        const airline = filterAirline.value;
        const maxFare = parseInt(filterFare.value);
        const sort = filterSort.value;

        if (airline) list = list.filter((f) => f.airline === airline);
        list = list.filter((f) => f.fare <= maxFare);
        if (sort === "low") list.sort((a, b) => a.fare - b.fare);
        else if (sort === "high") list.sort((a, b) => b.fare - a.fare);

        renderFlights(list);
      }

      // Search flights, then store results for filter chaining
      async function doSearch(source, destination, date) {
        const params = new URLSearchParams({ source, destination });
        if (date) params.set("date", new Date(date).toISOString());
        const flights = await apiGet("/flights/search?" + params.toString());
        allFlights = flights;
        filteredFlights = [...flights];
        applyFilters(); // filters apply over search results
      }

      function renderFlights(list) {
        if (!list || list.length === 0) {
          flightsList.innerHTML = "<p>No flights found.</p>";
          anime({
            targets: ".flight",
            translateX: [-40, 0],
            opacity: [0, 1],
            duration: 600,
            easing: "easeOutExpo",
            delay: anime.stagger(100), // each card animates one by one
          });

          return;
        }

        const rows = list
          .map((f) => {
            const flightId = f.flightId;
            const avail = f.seatsAvailable ?? 0;
            return `
      <div class="flight">
        <div>
          <strong>${escapeHtml(f.airline)}</strong>
          <div class="route">${escapeHtml(f.source)} ‚Üí ${escapeHtml(
              f.destination
            )}</div>
          <div class="time">
            ‚úàÔ∏è Depart: ${formatDate(f.departureTime)}<br>
            üïì Arrive: ${formatDate(f.arrivalTime)}
          </div>
          <div class="details">
            üí∫ Seats: ${avail} &nbsp;&nbsp; üí∞ Fare: <b>‚Çπ${f.fare}</b>
          </div>
        </div>
        <button ${
          avail <= 0 ? "disabled" : ""
        } data-id="${flightId}" class="btnBook">
          ${avail <= 0 ? "Sold Out" : "Book Now"}
        </button>
      </div>`;
          })
          .join("");

        flightsList.innerHTML = rows;

        // reattach click handlers
        document.querySelectorAll(".btnBook").forEach((b) =>
          b.addEventListener("click", (ev) => {
            const id = ev.target.dataset.id;
            console.log("Booking flight ID:", id);
            openBookModal(id);
          })
        );
      }

      function openBookModal(flightId) {
        console.log("Booking flight ID:", flightId);
        bookForm.flightId.value = flightId;
        modal.classList.remove("hidden");
      }
      async function openBookModal(flightId) {
        bookForm.flightId.value = flightId;
        modal.classList.remove("hidden");

        // Generate seats from 1A to 6F (36 seats)
        const preSeats = [];
        const rows = ["A", "B", "C", "D", "E", "F"];
        for (let r = 1; r <= 6; r++) {
          for (let c of rows) {
            preSeats.push(r + c);
          }
        }
        const seats = await apiGet("/flights/seatmap/" + flightId).catch(
          () => preSeats
        );

        // Fetch booked seats
        const booked = await apiGet("/bookings/seatmap/" + flightId).catch(
          () => []
        );

        console.log("Booked seats:", booked);
        console.log("All seats:", seats);
        seatGrid.innerHTML = seats
          .map(
            (s) => `
    <div class="seat ${booked.includes(s) ? "booked" : ""}" data-seat="${s}">
      ${s}
    </div>
  `
          )
          .join("");

        document.querySelectorAll(".seat:not(.booked)").forEach((seat) => {
          seat.addEventListener("click", () => {
            document
              .querySelectorAll(".seat")
              .forEach((x) => x.classList.remove("selected"));
            seat.classList.add("selected");
            bookForm.seatNo.value = seat.dataset.seat;
          });
        });
      }

      document
        .getElementById("btnCancelModal")
        .addEventListener("click", () => modal.classList.add("hidden"));

      const seatNoInput = document.getElementById("seatNo");
      bookForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!seatNoInput.value) {
          alert("Please select a seat before confirming your booking.");
          return;
        }
        const data = Object.fromEntries(new FormData(e.target));
        try {
          const payload = {
            flightId: Number(data.flightId),
            passengerName: data.passengerName,
            seatNo: data.seatNo,
          };
          const res = await apiPost("/bookings/create", payload);
          alert("Booked! Booking id: " + res.bookingId);
          modal.classList.add("hidden");
          loadAll();
        } catch (err) {
          alert("Booking failed: " + (err.message || JSON.stringify(err)));
        }
      });

      // initial load
      loadAll();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script>
      const themeToggle = document.getElementById("themeToggle");

      // Load saved theme
      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark");
        themeToggle.textContent = "‚òÄÔ∏è";
      }

      // Toggle theme on click
      themeToggle.addEventListener("click", () => {
        document.body.classList.toggle("dark");
        const isDark = document.body.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        themeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
      });
    </script>
    <canvas
      id="ambientCanvas"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: -1;
      "
    ></canvas>

    <script>
      const canvas = document.getElementById("ambientCanvas");
      const ctx = canvas.getContext("2d");
      let particles = [];

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      // Generate particles
      for (let i = 0; i < 50; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          r: Math.random() * 3 + 1,
          dx: (Math.random() - 0.5) * 0.4,
          dy: (Math.random() - 0.5) * 0.4,
        });
      }

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "rgba(255,255,255,0.85)";
        particles.forEach((p) => {
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fill();
          p.x += p.dx;
          p.y += p.dy;
          if (p.x < 0 || p.x > canvas.width) p.dx *= -1;
          if (p.y < 0 || p.y > canvas.height) p.dy *= -1;
        });

        requestAnimationFrame(animate);
      }
      animate();
    </script>
    <script>
      anime({
        targets: ".card, .top",
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 900,
        delay: anime.stagger(120),
        easing: "easeOutQuint",
      });
    </script>
  </body>
</html>
